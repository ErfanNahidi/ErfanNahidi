name: Generate GitHub Language Stats SVG

on:
  schedule:
    - cron: '0 */6 * * *'  # every 6 hours (reduced from hourly)
  workflow_dispatch:
    inputs:
      force_refresh:
        description: 'Force refresh all data'
        required: false
        default: 'false'

jobs:
  build-stats:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.PAT_1 || secrets.GITHUB_TOKEN }}

      - name: Install dependencies
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq
          python3 -m pip install --upgrade pip

      - name: Generate stats and SVG
        env:
          USERNAME: ErfanNahidi
          SECRET_PAT: ${{ secrets.PAT_1 }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail

          API="https://api.github.com"
          USER="$USERNAME"

          # Choose token with better logging
          if [ -n "${SECRET_PAT:-}" ]; then
            TOKEN="$SECRET_PAT"
            echo "âœ“ Using PAT_1 token"
          else
            TOKEN="$GITHUB_TOKEN"
            echo "âš  Using default GITHUB_TOKEN (rate limits may apply)"
          fi

          # Fetch all repos with improved error handling
          repos_file="repos_all.json"
          echo "[]" > "$repos_file"
          page=1
          total_fetched=0
          
          echo "ğŸ“¥ Fetching repositories..."
          while :; do
            resp=$(curl -sS -w "\n%{http_code}" \
              -H "Authorization: token $TOKEN" \
              -H "Accept: application/vnd.github.v3+json" \
              "${API}/users/${USER}/repos?per_page=100&page=${page}&type=owner")
            
            http_code=$(echo "$resp" | tail -n1)
            body=$(echo "$resp" | sed '$d')
            
            if [ "$http_code" != "200" ]; then
              echo "âŒ API request failed with status $http_code"
              exit 1
            fi
            
            cnt=$(echo "$body" | jq 'length')
            if [ "$cnt" -eq 0 ]; then
              break
            fi
            
            tmp=$(mktemp)
            jq -s '.[0] + .[1]' "$repos_file" <(echo "$body") > "$tmp" && mv "$tmp" "$repos_file"
            total_fetched=$((total_fetched + cnt))
            echo "  Page $page: $cnt repos (total: $total_fetched)"
            page=$((page+1))
            
            # Rate limit protection
            sleep 0.5
          done

          total_repos=$(jq 'length' "$repos_file")
          active_repos=$(jq '[.[] | select(.fork==false and .archived==false)] | length' "$repos_file")
          echo "âœ“ Fetched $total_repos total repos ($active_repos active)"

          # Build language data with progress
          langs_array="langs_array.json"
          echo "[" > "$langs_array"
          first=1
          count=0
          
          echo "ğŸ“Š Analyzing languages..."
          jq -c '.[] | select(.fork==false and .archived==false) | {name, languages_url}' "$repos_file" | while read -r line; do
            repo_name=$(echo "$line" | jq -r '.name')
            lang_url=$(echo "$line" | jq -r '.languages_url')
            
            if [ -z "$lang_url" ] || [ "$lang_url" = "null" ]; then
              continue
            fi
            
            ljson=$(curl -sS -H "Authorization: token $TOKEN" \
              -H "Accept: application/vnd.github.v3+json" "$lang_url" 2>/dev/null || echo "{}")
            
            if [ "$first" -eq 1 ]; then
              echo "$ljson" >> "$langs_array"
              first=0
            else
              echo ",$ljson" >> "$langs_array"
            fi
            
            count=$((count + 1))
            if [ $((count % 10)) -eq 0 ]; then
              echo "  Processed $count repos..."
            fi
            
            sleep 0.3
          done
          echo "]" >> "$langs_array"
          echo "âœ“ Language analysis complete"

          # Generate enhanced SVG
          python3 - <<'PY'
import json
import sys
import os
from datetime import datetime

langs_file = "langs_array.json"
data = []

try:
    with open(langs_file, 'r') as f:
        data = json.load(f)
except Exception as e:
    print(f"âš  Error loading language data: {e}")
    data = []

# Aggregate language bytes
agg = {}
for entry in data:
    if not isinstance(entry, dict):
        continue
    for lang, bytes_count in entry.items():
        try:
            agg[lang] = agg.get(lang, 0) + int(bytes_count)
        except (ValueError, TypeError):
            pass

total = sum(agg.values())

if total == 0:
    # Enhanced fallback SVG
    svg = """<svg xmlns="http://www.w3.org/2000/svg" width="700" height="140" role="img" aria-label="GitHub Stats">
  <defs>
    <linearGradient id="bg" x1="0%" y1="0%" x2="100%" y2="100%">
      <stop offset="0%" style="stop-color:#0d1117;stop-opacity:1" />
      <stop offset="100%" style="stop-color:#161b22;stop-opacity:1" />
    </linearGradient>
  </defs>
  <rect width="100%" height="100%" fill="url(#bg)"/>
  <text x="350" y="60" fill="#c9d1d9" font-family="'Segoe UI', Verdana, sans-serif" font-size="20" text-anchor="middle" font-weight="600">ğŸ“Š GitHub Language Stats</text>
  <text x="350" y="90" fill="#8b949e" font-family="'Segoe UI', Verdana, sans-serif" font-size="13" text-anchor="middle">No public repositories or language data available</text>
  <text x="350" y="115" fill="#6e7681" font-family="'Segoe UI', Verdana, sans-serif" font-size="11" text-anchor="middle">Last updated: """ + datetime.now().strftime("%Y-%m-%d %H:%M UTC") + """</text>
</svg>"""
    with open("github-readme-stats.svg", "w", encoding="utf-8") as f:
        f.write(svg)
    print("âš  Generated fallback SVG (no data)")
    sys.exit(0)

# Sort and get top languages
items = sorted(agg.items(), key=lambda x: -x[1])[:12]  # Increased to top 12

# Enhanced SVG styling
width = 800
pad = 20
bar_x = 200
bar_w = width - bar_x - pad - 80
bar_h = 24
gap = 10
header_h = 60
height = header_h + (bar_h + gap) * len(items) + pad

# Modern color palette (GitHub-inspired)
colors = [
    "#3572A5", "#e34c26", "#f1e05a", "#178600", "#563d7c",
    "#b07219", "#00ADD8", "#89e051", "#2b7489", "#701516",
    "#6f42c1", "#c6538c", "#ff6f00", "#DA5B0B"
]

# Format bytes for display
def format_bytes(b):
    if b < 1024:
        return f"{b}B"
    elif b < 1024**2:
        return f"{b/1024:.1f}KB"
    elif b < 1024**3:
        return f"{b/(1024**2):.1f}MB"
    else:
        return f"{b/(1024**3):.2f}GB"

lines = []
lines.append(f'<svg xmlns="http://www.w3.org/2000/svg" width="{width}" height="{height}" role="img" aria-label="GitHub Language Statistics">')

# Background gradient
lines.append('  <defs>')
lines.append('    <linearGradient id="bg" x1="0%" y1="0%" x2="100%" y2="100%">')
lines.append('      <stop offset="0%" style="stop-color:#0d1117;stop-opacity:1" />')
lines.append('      <stop offset="100%" style="stop-color:#161b22;stop-opacity:1" />')
lines.append('    </linearGradient>')
lines.append('  </defs>')
lines.append('  <rect width="100%" height="100%" fill="url(#bg)" rx="10"/>')

# Header
username = os.environ.get("USERNAME", "User")
lines.append(f'  <text x="20" y="32" fill="#c9d1d9" font-family="\'Segoe UI\', Verdana, sans-serif" font-size="20" font-weight="600">ğŸ“Š Top Languages - {username}</text>')
lines.append(f'  <text x="20" y="50" fill="#8b949e" font-family="\'Segoe UI\', Verdana, sans-serif" font-size="11">Total: {format_bytes(total)} across {len(items)} languages</text>')

y = header_h
for i, (lang, bytes_count) in enumerate(items):
    pct = bytes_count / total * 100
    bar_len = max(int(bar_w * (bytes_count / total)), 2)
    color = colors[i % len(colors)]
    
    # Language name
    lines.append(f'  <text x="20" y="{y+17}" fill="#c9d1d9" font-family="\'Segoe UI\', Verdana, sans-serif" font-size="13" font-weight="500">{lang}</text>')
    
    # Background bar
    lines.append(f'  <rect x="{bar_x}" y="{y}" width="{bar_w}" height="{bar_h}" rx="4" fill="#21262d"/>')
    
    # Filled bar with animation-ready class
    lines.append(f'  <rect x="{bar_x}" y="{y}" width="{bar_len}" height="{bar_h}" rx="4" fill="{color}" opacity="0.9"/>')
    
    # Percentage
    lines.append(f'  <text x="{bar_x + bar_w + 10}" y="{y+17}" fill="#8b949e" font-family="\'Segoe UI\', Verdana, sans-serif" font-size="12">{pct:.1f}%</text>')
    
    y += bar_h + gap

# Footer timestamp
timestamp = datetime.now().strftime("%Y-%m-%d %H:%M UTC")
lines.append(f'  <text x="{width/2}" y="{height-8}" fill="#6e7681" font-family="\'Segoe UI\', Verdana, sans-serif" font-size="10" text-anchor="middle">Last updated: {timestamp}</text>')
lines.append('</svg>')

svg_content = "\n".join(lines)
with open('github-readme-stats.svg', 'w', encoding='utf-8') as f:
    f.write(svg_content)

print(f"âœ“ Generated SVG with {len(items)} languages")
print(f"  Total code: {format_bytes(total)}")
print(f"  Top language: {items[0][0]} ({items[0][1]/total*100:.1f}%)")
PY

          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“„ SVG Preview (first 25 lines):"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          head -n 25 github-readme-stats.svg || true
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: Commit and push
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
          
          if [ -f github-readme-stats.svg ]; then
            git add github-readme-stats.svg
            
            if git diff --staged --quiet; then
              echo "â„¹ï¸  No changes detected, skipping commit"
            else
              git commit -m "chore: update language stats [skip ci]" \
                         -m "Generated by GitHub Actions" \
                         -m "Run ID: ${{ github.run_id }}"
              git push
              echo "âœ… Successfully committed and pushed changes"
            fi
          else
            echo "âŒ SVG file not found!"
            exit 1
          fi
