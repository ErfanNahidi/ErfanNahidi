name: Generate and Commit GitHub Language Stats SVG (final)

on:
  schedule:
    - cron: '0 * * * *'     # every hour
  workflow_dispatch:        # manual run allowed

jobs:
  build-stats:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install jq
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq

      - name: Generate stats and SVG
        env:
          USERNAME: ErfanNahidi
          SECRET_PAT: ${{ secrets.PAT_1 }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail

          API="https://api.github.com"
          USER="$USERNAME"

          # choose token: prefer PAT_1 if provided
          if [ -n "${SECRET_PAT:-}" ]; then
            TOKEN="$SECRET_PAT"
            echo "Using PAT_1 token"
          else
            TOKEN="$GITHUB_TOKEN"
            echo "Using default GITHUB_TOKEN"
          fi

          # fetch all repos (owner type) with pagination
          repos_file="repos_all.json"
          echo "[]" > "$repos_file"
          page=1
          while :; do
            if [ -n "${TOKEN:-}" ]; then
              resp=$(curl -sS -H "Authorization: token $TOKEN" -H "Accept: application/vnd.github.v3+json" "${API}/users/${USER}/repos?per_page=100&page=${page}&type=owner")
            else
              resp=$(curl -sS -H "Accept: application/vnd.github.v3+json" "${API}/users/${USER}/repos?per_page=100&page=${page}&type=owner")
            fi
            cnt=$(echo "$resp" | jq 'length')
            if [ "$cnt" -eq 0 ]; then
              break
            fi
            tmp=$(mktemp)
            jq -s '.[0] + .[1]' "$repos_file" <(echo "$resp") > "$tmp" && mv "$tmp" "$repos_file"
            page=$((page+1))
          done

          total_repos=$(jq 'length' "$repos_file" || echo 0)
          echo "Fetched repos: $total_repos"

          # build array of language JSONs
          langs_array="langs_array.json"
          echo "[" > "$langs_array"
          first=1
          jq -c '.[] | select(.fork==false and .archived==false) | {languages_url}' "$repos_file" | while read -r line; do
            lang_url=$(echo "$line" | jq -r '.languages_url')
            if [ -z "$lang_url" ] || [ "$lang_url" = "null" ]; then
              continue
            fi
            if [ -n "${TOKEN:-}" ]; then
              ljson=$(curl -sS -H "Authorization: token $TOKEN" -H "Accept: application/vnd.github.v3+json" "$lang_url" || echo "{}")
            else
              ljson=$(curl -sS -H "Accept: application/vnd.github.v3+json" "$lang_url" || echo "{}")
            fi
            # append with comma separation
            if [ "$first" -eq 1 ]; then
              echo "$ljson" >> "$langs_array"
              first=0
            else
              echo ",$ljson" >> "$langs_array"
            fi
          done
          echo "]" >> "$langs_array"

          # generate SVG via python: aggregate language bytes and render top 10 bars
          python3 - <<'PY'
import json, sys, os
langs_file = "langs_array.json"
data = []
try:
    data = json.load(open(langs_file))
except Exception:
    data = []
agg = {}
for entry in data:
    if not isinstance(entry, dict):
        continue
    for k, v in entry.items():
        try:
            agg[k] = agg.get(k, 0) + int(v)
        except Exception:
            pass

total = sum(agg.values())
if total == 0:
    # fallback svg
    svg = """<svg xmlns="http://www.w3.org/2000/svg" width="640" height="120" role="img" aria-label="GitHub Stats">
  <rect width="100%" height="100%" fill="#0b1220"/>
  <text x="20" y="45" fill="#c9d1d9" font-family="Verdana" font-size="18">GitHub stats not available</text>
  <text x="20" y="80" fill="#9aa4ae" font-family="Verdana" font-size="12">No public repositories or language data to display</text>
</svg>"""
    open("github-readme-stats.svg", "w", encoding="utf-8").write(svg)
    print("WROTE fallback SVG")
    sys.exit(0)

items = sorted(agg.items(), key=lambda x: -x[1])[:10]
width = 700
pad = 20
bar_x = 180
bar_w = width - bar_x - pad
bar_h = 20
gap = 8
height = pad + max((bar_h + gap) * len(items), 100) + 10
colors = [
  "#2b7489","#f1e05a","#e34c26","#563d7c","#3572A5",
  "#b07219","#38A2A4","#701516","#6f42c1","#c6538c"
]
lines = []
lines.append(f'<svg xmlns="http://www.w3.org/2000/svg" width="{width}" height="{height}" role="img" aria-label="GitHub language stats">')
lines.append(f'<rect width="100%" height="100%" fill="#0b1220"/>')
lines.append(f'<text x="20" y="28" fill="#c9d1d9" font-family="Verdana" font-size="16">Top languages for {os.environ.get("USERNAME","")}</text>')
y = pad + 30
i = 0
for lang, bytes_count in items:
    pct = bytes_count / total * 100
    bar_len = int(bar_w * (bytes_count/total))
    color = colors[i % len(colors)]
    lines.append(f'<text x="20" y="{y+14}" fill="#c9d1d9" font-family="Verdana" font-size="12">{lang}</text>')
    lines.append(f'<rect x="{bar_x}" y="{y}" width="{bar_w}" height="{bar_h}" rx="3" fill="#1b2636"/>')
    lines.append(f'<rect x="{bar_x}" y="{y}" width="{bar_len}" height="{bar_h}" rx="3" fill="{color}"/>')
    lines.append(f'<text x="{bar_x + bar_w + 8}" y="{y+14}" fill="#9aa4ae" font-family="Verdana" font-size="12">{pct:.1f}%</text>')
    y += bar_h + gap
    i += 1
lines.append('</svg>')
open('github-readme-stats.svg','w',encoding='utf-8').write("\n".join(lines))
print("WROTE github-readme-stats.svg")
PY

          # show head of file for logs
          echo "------ SVG PREVIEW ------"
          head -n 20 github-readme-stats.svg || true
          echo "------ END PREVIEW ------"

      - name: Commit and push github-readme-stats.svg
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "actions@github.com"
          git add github-readme-stats.svg
          git commit -m "chore: update github-readme-stats.svg [ci skip]" || echo "No changes to commit"
          git push
